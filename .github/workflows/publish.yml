name: Publish Quarto Site

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python Dependencies
        run: |
          pip install jupyter pyyaml jupyter-cache

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: '1.4.553'

      - name: Install TinyTeX
        run: |
          quarto install tinytex

      - name: Create Downloads Directory
        run: |
          mkdir -p downloads

      - name: Create LaTeX header file
        run: |
          cat > /tmp/code-style.tex << 'LATEX_EOF'
          % Code-Block Formatierung fuer Zeilenumbruch
          \usepackage{fvextra}
          \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,breakanywhere,breaksymbol={},breakanywheresymbolpre={},commandchars=\\\{\},fontsize=\scriptsize}

          % Verbatim-Output umbrechen
          \usepackage{fancyvrb}
          \fvset{breaklines=true,breakanywhere=true,fontsize=\scriptsize}
          \RecustomVerbatimEnvironment{verbatim}{Verbatim}{breaklines,breakanywhere,fontsize=\scriptsize}

          % Tabellen automatisch skalieren
          \usepackage{adjustbox}
          \usepackage{etoolbox}
          \AtBeginEnvironment{longtable}{\scriptsize}
          \AtBeginEnvironment{tabular}{\scriptsize}

          % Longtable auf Textbreite skalieren
          \let\oldlongtable\longtable
          \let\endoldlongtable\endlongtable
          \renewenvironment{longtable}{\begin{adjustbox}{max width=\textwidth}\begin{oldlongtable}}{\end{oldlongtable}\end{adjustbox}}
          LATEX_EOF

      - name: Generate PDF, LaTeX, DOCX for all notebooks
        run: |
          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              filename=$(basename "$notebook" .ipynb)
              echo "Processing: $filename"

              # PDF mit LaTeX (mit Code-Umbruch und skalierten Tabellen)
              quarto render "$notebook" --no-execute --to pdf \
                -M keep-tex:true \
                -M geometry:"left=1cm,right=1cm,top=1.5cm,bottom=1.5cm" \
                -M fig-width:6.5 \
                -M fig-height:4 \
                -M fontsize:9pt \
                -M include-in-header:/tmp/code-style.tex \
                -o "${filename}.pdf" \
                --output-dir downloads/ || echo "PDF failed for $filename"

              # LaTeX und Bilder als ZIP für Overleaf erstellen
              if [ -f "notebooks/${filename}.tex" ]; then
                # ZIP-Ordner mit korrektem Namen erstellen (muss zum LaTeX-Pfad passen)
                mkdir -p "downloads/${filename}_latex/${filename}_files/figure-pdf"

                # .tex Datei kopieren
                cp "notebooks/${filename}.tex" "downloads/${filename}_latex/main.tex"

                # Bilder-Ordner kopieren falls vorhanden (mit Original-Struktur)
                if [ -d "notebooks/${filename}_files" ]; then
                  cp -r "notebooks/${filename}_files/"* "downloads/${filename}_latex/${filename}_files/"
                fi

                # Im LaTeX die Pfade anpassen (relativ machen)
                # Nichts zu ändern - Pfade sind bereits relativ wie ${filename}_files/figure-pdf/...

                # ZIP erstellen
                cd downloads
                zip -r "${filename}_latex.zip" "${filename}_latex"
                cd ..

                # Einzelne .tex auch behalten
                cp "downloads/${filename}_latex/main.tex" "downloads/${filename}.tex"

                # Temporären Ordner aufräumen
                rm -rf "downloads/${filename}_latex"
              fi

              # DOCX mit expliziten Formatierungsoptionen
              quarto render "$notebook" --no-execute --to docx \
                -M toc:false \
                -M number-sections:true \
                -M fig-width:5.5 \
                -M fig-height:4 \
                -o "${filename}.docx" \
                --output-dir downloads/ || echo "DOCX failed for $filename"

              # Aufräumen
              rm -rf "notebooks/${filename}_files"
            fi
          done

      - name: Generate Downloads List
        run: |
          # Erstelle die Markdown-Tabelle
          echo "| Bericht | PDF | LaTeX | LaTeX+Bilder | Word |" > _downloads-list.md
          echo "|---------|-----|-------|--------------|------|" >> _downloads-list.md

          for notebook in notebooks/*.ipynb; do
            if [ -f "$notebook" ]; then
              filename=$(basename "$notebook" .ipynb)

              # Titel aus Notebook extrahieren
              title=$(python3 scripts/extract_title.py "$notebook" "$filename")

              echo "| $title | [PDF](/downloads/${filename}.pdf) | [.tex](/downloads/${filename}.tex) | [ZIP](/downloads/${filename}_latex.zip) | [Word](/downloads/${filename}.docx) |" >> _downloads-list.md
            fi
          done

          echo "=== Downloads List ==="
          cat _downloads-list.md

      - name: List generated downloads
        run: |
          echo "=== Generated Downloads ==="
          ls -la downloads/

      - name: Render HTML (Website)
        run: |
          quarto render --no-execute

      - name: Verify downloads in _site
        run: |
          echo "=== _site/downloads content ==="
          ls -la _site/downloads/ || echo "downloads folder missing in _site"

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
